#!/bin/bash

# Task 2: Installing and Configuring NGINX
az vm create \
  --resource-group learn-alda231f-2ef-4315-a62f-01b313064Â£29 \
  --name magidi-vm \
  --public-ip-sku Standard \
  --image UbuntuLTS \
  --admin-username magidi \
  --generate-ssh-keys


# SSH into the VM
ssh magidi@13.93.164.165

# Install NGINX
sudo apt-get update
sudo apt-get install -y nginx

# Check if nginx is installed
sytemctl is-active nginc
sudo systemctl start nginx

# Create directory and set up basic webpage
sudo mkdir -p /var/www/html/labs
sudo chown -R www-data:www-data /var/www/html

# Create symbolic link
ln -s /var/www/html/labs ~/html

# Create index.html file
echo "<!DOCTYPE html> 
<html>
<head>
  <title>STUDENT INFORMATION PAGE</title></head>
<body>
    <h1>STUDENT INFORMATION PAGE</h1>

    <p>
        Initials: K Matloga; Z Magidi
<br>
        Name: Karabo; Zwivhuya <br>
        Student No: 221060375; 218460279
<br>
        Course: Electrical Engineering: Computer Systems
</p>
</body>
</html>" | sudo tee /var/www/html/labs/index.html

# Test NGINX
sudo systemctl start nginx
sudo systemctl enable nginx

# Task 3: Setting Up MySQL Database

# Install MySQL Server
sudo apt-get update
sudo apt-get install -y mysql-server

# Secure MySQL installation
sudo mysql_secure_installation

# Configure MySQL for Strong Passwords and Remote Access

# Generate a strong password for the root user
ROOT_PASSWORD=$(openssl rand -base64 12)

# Set a strong password for the root user
sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH 'mysql_native_password' BY '$ROOT_PASSWORD';"

# Allow remote access to the root user (replace 'your_ip' with your IP address)
YOUR_IP='13.93.164.165'
sudo mysql -e "CREATE USER 'root'@'$YOUR_IP' IDENTIFIED BY '$ROOT_PASSWORD';"
sudo mysql -e "GRANT ALL PRIVILEGES ON . TO 'root'@'$YOUR_IP' WITH GRANT OPTION;"
sudo mysql -e "FLUSH PRIVILEGES;"

# Configure Firewall Rules for MySQL (default port 3306)
sudo ufw allow 3306


# Enable ufw (Uncomplicated firewall)
sudo ufw --force enable

# Display the status of UFW
sudo ufw status

# Display MySQL root password for reference
echo "MySQL Root Password: $ROOT_PASSWORD"


# Accessing MySQL
mysql -u root -p

# Saving script to a file
chmod +x setup_mysql.sh

# Run the script on VM after connecting via SSH
./setup_mysql.sh

# Task 4: Creating Student Table and Data

# Access MySQL and create database and table
mysql -u root -p <<MYSQL_SCRIPT
CREATE DATABASE IF NOT EXISTS student_records;
USE student_records;
CREATE TABLE IF NOT EXISTS students (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    age INT,
    gender VARCHAR(10),
    course VARCHAR(255)
);
INSERT INTO students (name, age, gender, course) VALUES
    ('Magidi Z', 20, 'Male', 'Computer Systems'),
    ('Karabo', 21, 'Male', 'Computer Systems'),
    
FLUSH PRIVILEGES;
MYSQL_SCRIPT

echo "Student database and table created with sample data."
